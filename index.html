<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cric Scorecard – Prototype</title>
    <!-- Tailwind Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 + ReactDOM 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-zinc-950">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      function App() {
        // ==== Basic match state ====
        const [matchNo] = useState(1);
        const today = useMemo(
          () => new Date().toLocaleDateString("en-IN", { day: "2-digit", month: "short", year: "numeric" }),
          []
        );
        const [innings, setInnings] = useState(1); // 1 or 2

        // Overs / balls
        const ballsPerOver = 6;
        const [totalOvers, setTotalOvers] = useState({ 1: 8, 2: 8 });
        const [ballsBowled, setBallsBowled] = useState({ 1: 0, 2: 0 }); // legal balls bowled per innings

        // Score
        const [score, setScore] = useState({ 1: { runs: 0, wkts: 0 }, 2: { runs: 0, wkts: 0 } });

        // Players (saved list + on-field)
        const [savedPlayers, setSavedPlayers] = useState([
          { name: "Ajay", common: false },
          { name: "Rohit", common: false },
          { name: "Rahul", common: false },
        ]);
        const [bowler, setBowler] = useState({ 1: "—", 2: "—" });
        const [batsmen, setBatsmen] = useState({
          1: { striker: "Ajay", nonStriker: "Rohit" },
          2: { striker: "—", nonStriker: "—" },
        });

        // Per-innings stats stores
        const [battingStats, setBattingStats] = useState({ 1: {}, 2: {} }); // name -> {runs, balls, fours, sixes, out}
        const [bowlingStats, setBowlingStats] = useState({ 1: {}, 2: {} }); // name -> {balls, runs, wickets, maidens}

        // Over event arrays & current-over runs for maidens
        const [currentOverEvents, setCurrentOverEvents] = useState({ 1: [], 2: [] });
        const [currentOverRuns, setCurrentOverRuns] = useState({ 1: 0, 2: 0 });
        const [lastOverStr, setLastOverStr] = useState({ 1: "—", 2: "—" });

        // Chasing / target (shown only in Innings 2)
        const [target, setTarget] = useState(0);

        // Menus / modals
        const [menuOpen, setMenuOpen] = useState(false); // hamburger
        const [summaryOpen, setSummaryOpen] = useState(false); // innings summary modal
        const [picker, setPicker] = useState(null); // { role: 'bowler'|'striker'|'nonStriker' }
        const [newPlayerName, setNewPlayerName] = useState("");
        const [newPlayerCommon, setNewPlayerCommon] = useState(false);
        const [wicketOpen, setWicketOpen] = useState(false);

        // NEW: Setup wizard state for starting Innings 2
        const [setupOpen, setSetupOpen] = useState(false);
        const [setupStep, setSetupStep] = useState(1); // 1: striker, 2: non-striker, 3: bowler
        const [setupStriker, setSetupStriker] = useState("");
        const [setupNonStriker, setSetupNonStriker] = useState("");
        const [setupBowler, setSetupBowler] = useState("");
        const [setupSearch, setSetupSearch] = useState("");

        // Derived
        const activeOvers = totalOvers[innings];
        const activeBalls = ballsBowled[innings];
        const oversDisplay = `${Math.floor(activeBalls / ballsPerOver)}.${activeBalls % ballsPerOver}`;
        const ballsRemaining = activeOvers * ballsPerOver - activeBalls;
        const reqRuns = Math.max(0, target - score[2].runs);
        const rrr = useMemo(() => {
          if (innings !== 2) return 0;
          if (ballsRemaining <= 0) return 0;
          return (reqRuns * 6) / ballsRemaining;
        }, [innings, reqRuns, ballsRemaining]);

        // ===== Utils: ensure stat records =====
        const ensureBatter = (name) => {
          if (!name || name === "—") return;
          setBattingStats((prev) => {
            const curInn = { ...(prev[innings] || {}) };
            if (!curInn[name]) curInn[name] = { runs: 0, balls: 0, fours: 0, sixes: 0, out: false };
            return { ...prev, [innings]: curInn };
          });
        };
        const ensureBowler = (name) => {
          if (!name || name === "—") return;
          setBowlingStats((prev) => {
            const curInn = { ...(prev[innings] || {}) };
            if (!curInn[name]) curInn[name] = { balls: 0, runs: 0, wickets: 0, maidens: 0 };
            return { ...prev, [innings]: curInn };
          });
        };

        // ===== Player picker =====
        const openPicker = (role) => {
          setNewPlayerName("");
          setNewPlayerCommon(false);
          setPicker({ role });
        };
        const applyPlayer = (name) => {
          if (!name) return;
          // Add to saved list if missing
          setSavedPlayers((prev) => (prev.some((p) => p.name.toLowerCase() === name.toLowerCase()) ? prev : [...prev, { name, common: false }]));

          if (picker?.role === "bowler") {
            setBowler((p) => ({ ...p, [innings]: name }));
            ensureBowler(name);
            // New over for this bowler
            setCurrentOverRuns((r) => ({ ...r, [innings]: 0 }));
          } else if (picker?.role) {
            setBatsmen((p) => ({ ...p, [innings]: { ...p[innings], [picker.role]: name } }));
            ensureBatter(name);
          }
          setPicker(null);
        };
        const addNewPlayer = () => {
          if (!newPlayerName.trim()) return;
          const entry = { name: newPlayerName.trim(), common: newPlayerCommon };
          setSavedPlayers((prev) => (prev.some((p) => p.name.toLowerCase() === entry.name.toLowerCase()) ? prev.map((p) => (p.name.toLowerCase() === entry.name.toLowerCase() ? entry : p)) : [...prev, entry]));
          applyPlayer(entry.name);
        };
        const toggleCommonFor = (name) => {
          setSavedPlayers((prev) => prev.map((p) => (p.name === name ? { ...p, common: !p.common } : p)));
        };

        // ===== Wicket flow =====
        const [pendingReplaceRole, setPendingReplaceRole] = useState(null); // 'striker' | 'nonStriker'
        const startWicketFlow = () => { setPendingReplaceRole(null); setWicketOpen(true); };
        const chooseOutAndPickReplacement = (role) => {
          setPendingReplaceRole(role);
          // Mark out in batting stats
          const outName = role === "striker" ? batsmen[innings].striker : batsmen[innings].nonStriker;
          ensureBatter(outName);
          setBattingStats((prev) => {
            const curInn = { ...(prev[innings] || {}) };
            if (curInn[outName]) curInn[outName] = { ...curInn[outName], out: true };
            return { ...prev, [innings]: curInn };
          });
          setWicketOpen(false);
          openPicker(role); // choose replacement
        };

        // ===== Undo history =====
        const [history, setHistory] = useState([]);
        const snapshot = () => {
          setHistory((h) => [ ...h, JSON.stringify({ score, ballsBowled, currentOverEvents, currentOverRuns, lastOverStr, batsmen, bowler, battingStats, bowlingStats }) ]);
        };
        const undo = () => {
          const h = [...history];
          const last = h.pop();
          if (!last) return;
          const state = JSON.parse(last);
          setScore(state.score);
          setBallsBowled(state.ballsBowled);
          setCurrentOverEvents(state.currentOverEvents);
          setCurrentOverRuns(state.currentOverRuns);
          setLastOverStr(state.lastOverStr);
          setBatsmen(state.batsmen);
          setBowler(state.bowler);
          setBattingStats(state.battingStats);
          setBowlingStats(state.bowlingStats);
          setHistory(h);
        };

        // ===== Scoring =====
        const symbolFor = (ev) => {
          switch (ev.kind) {
            case "RUNS": return String(ev.runs || 0);
            case "DOT": return ".";
            case "WIDE": return "Wd";
            case "NOBALL": return "Nb";
            case "WICKET": return "W";
            default: return "";
          }
        };

        const recordBall = (ev) => {
          // ev: { kind: 'RUNS'|'DOT'|'WIDE'|'NOBALL'|'WICKET', runs?, legal: boolean }
          snapshot();

          const striker = batsmen[innings].striker;
          const curBowler = bowler[innings];
          ensureBatter(striker);
          ensureBowler(curBowler);

          // Scoreboard totals
          setScore((prev) => {
            const cur = { ...prev };
            const s = cur[innings];
            if (ev.kind === "RUNS") s.runs += ev.runs || 0;
            if (ev.kind === "WIDE") s.runs += 1;
            if (ev.kind === "NOBALL") s.runs += 0; // your rule
            if (ev.kind === "WICKET") s.wkts += 1;
            return cur;
          });

          // Over strip
          setCurrentOverEvents((prev) => {
            const arr = prev[innings] ? [...prev[innings]] : [];
            arr.push({ kind: ev.kind, runs: ev.runs, legal: ev.legal });
            return { ...prev, [innings]: arr };
          });

          // Batting stats
          if (ev.kind === "RUNS") {
            setBattingStats((prev) => {
              const inn = { ...(prev[innings] || {}) };
              const bs = { ...(inn[striker] || { runs: 0, balls: 0, fours: 0, sixes: 0, out: false }) };
              bs.runs += ev.runs || 0;
              bs.balls += 1;
              if (ev.runs === 4) bs.fours += 1;
              if (ev.runs === 6) bs.sixes += 1;
              inn[striker] = bs; return { ...prev, [innings]: inn };
            });
          } else if (ev.kind === "DOT") {
            setBattingStats((prev) => { const inn = { ...(prev[innings] || {}) }; const bs = { ...(inn[striker] || { runs: 0, balls: 0, fours: 0, sixes: 0, out: false }) }; bs.balls += 1; inn[striker] = bs; return { ...prev, [innings]: inn }; });
          } else if (ev.kind === "WICKET") {
            // Count ball faced to striker by default
            setBattingStats((prev) => { const inn = { ...(prev[innings] || {}) }; const bs = { ...(inn[striker] || { runs: 0, balls: 0, fours: 0, sixes: 0, out: false }) }; bs.balls += 1; inn[striker] = bs; return { ...prev, [innings]: inn }; });
          }

          // Bowling stats
          setBowlingStats((prev) => {
            const inn = { ...(prev[innings] || {}) };
            const bs = { ...(inn[curBowler] || { balls: 0, runs: 0, wickets: 0, maidens: 0 }) };
            if (ev.kind === "RUNS") { bs.runs += ev.runs || 0; if (ev.legal) bs.balls += 1; }
            else if (ev.kind === "DOT") { if (ev.legal) bs.balls += 1; }
            else if (ev.kind === "WIDE") { bs.runs += 1; }
            else if (ev.kind === "NOBALL") { /* 0 runs + re-ball */ }
            else if (ev.kind === "WICKET") { bs.wickets += 1; if (ev.legal) bs.balls += 1; }
            inn[curBowler] = bs; return { ...prev, [innings]: inn };
          });

          // Current-over runs (for maiden detection)
          setCurrentOverRuns((r) => ({ ...r, [innings]: r[innings] + (ev.kind === "RUNS" ? (ev.runs || 0) : ev.kind === "WIDE" ? 1 : 0) }));

          // Legal ball count
          if (ev.legal) setBallsBowled((prev) => ({ ...prev, [innings]: prev[innings] + 1 }));

          // Auto striker swap on odd runs
          if (ev.kind === "RUNS" && (ev.runs || 0) % 2 === 1) {
            setBatsmen((p) => ({ ...p, [innings]: { striker: p[innings].nonStriker, nonStriker: p[innings].striker } }));
          }
        };

        const legalBallsThisOver = currentOverEvents[innings]?.filter((b) => b.legal).length || 0;

        const endOver = () => {
          // Move to last over string
          const str = (currentOverEvents[innings] || []).map((ev) => symbolFor(ev)).join(" ") || "—";
          setLastOverStr((prev) => ({ ...prev, [innings]: str }));

          // Maidens for current bowler
          if (currentOverRuns[innings] === 0) {
            const cb = bowler[innings];
            setBowlingStats((prev) => { const inn = { ...(prev[innings] || {}) }; const bs = { ...(inn[cb] || { balls: 0, runs: 0, wickets: 0, maidens: 0 }) }; bs.maidens += 1; inn[cb] = bs; return { ...prev, [innings]: inn }; });
          }

          // Reset current over trackers
          setCurrentOverEvents((prev) => ({ ...prev, [innings]: [] }));
          setCurrentOverRuns((r) => ({ ...r, [innings]: 0 }));

          // Auto striker swap at end of over
          setBatsmen((p) => ({ ...p, [innings]: { striker: p[innings].nonStriker, nonStriker: p[innings].striker } }));

          // Ask for next bowler
          openPicker("bowler");
        };

        const finalizeOverIfComplete = () => {
          if (legalBallsThisOver >= ballsPerOver) endOver();
        };

        // Watch for automatic end-of-over when 6 legal balls bowled
        useEffect(() => { finalizeOverIfComplete(); /* eslint-disable-next-line */ }, [currentOverEvents, ballsBowled, innings]);

        // Buttons
        const addRuns = (n) => recordBall({ kind: "RUNS", runs: n, legal: true });
        const dot = () => recordBall({ kind: "DOT", legal: true });
        const wide = () => recordBall({ kind: "WIDE", legal: false });
        const noBall = () => recordBall({ kind: "NOBALL", legal: false });
        const wicket = () => { recordBall({ kind: "WICKET", legal: true }); startWicketFlow(); };
        const manualOver = () => { if (legalBallsThisOver < ballsPerOver) { window.alert("Need 6 legal balls to end the over."); return; } endOver(); };

        // Edit overs mid-innings
        const editOvers = () => {
          const current = activeOvers;
          const val = window.prompt("Set total overs for this innings", String(current));
          if (val === null || val === "") return; const n = Math.max(1, Number(val));
          setTotalOvers((prev) => ({ ...prev, [innings]: n }));
        };

        // Display helpers
        const currentOverStr = (currentOverEvents[innings] || []).map((ev) => symbolFor(ev)).join(" ") || "—";
        const econ = (runs, balls) => (balls ? (runs * 6) / balls : 0);
        const oversFmt = (balls) => `${Math.floor(balls / ballsPerOver)}.${balls % ballsPerOver}`;

        // ===== Menu actions =====
        const endInnings = () => {
          if (innings === 1) {
            // Set target for chase
            const targetRuns = score[1].runs + 1; // simple target
            setTarget(targetRuns);

            // Mirror overs from Innings 1 -> Innings 2 so balls remaining matches your match setup
            setTotalOvers((p) => ({ ...p, 2: p[1] }));

            // Switch to Innings 2 and reset basics
            setInnings(2);
            setBallsBowled((p) => ({ ...p, 2: 0 }));
            setScore((p) => ({ ...p, 2: { runs: 0, wkts: 0 } }));
            setCurrentOverEvents((p) => ({ ...p, 2: [] }));
            setCurrentOverRuns((p) => ({ ...p, 2: 0 }));
            setLastOverStr((p) => ({ ...p, 2: "—" }));
            setBowler((p) => ({ ...p, 2: "—" }));
            setBatsmen((p) => ({ ...p, 2: { striker: "—", nonStriker: "—" } }));
            setBattingStats((p) => ({ ...p, 2: {} }));
            setBowlingStats((p) => ({ ...p, 2: {} }));
            setMenuOpen(false);
            // Open setup wizard for Innings 2
            setSetupStriker(""); setSetupNonStriker(""); setSetupBowler(""); setSetupStep(1); setSetupOpen(true);
          } else {
            window.alert("Already in Innings 2.");
          }
        };

        // ===== Components =====
        const MenuModal = () => (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center" onClick={() => setMenuOpen(false)}>
            <div className="bg-zinc-900 text-zinc-100 w-full sm:w-[420px] rounded-t-2xl sm:rounded-2xl p-4" onClick={(e) => e.stopPropagation()}>
              <div className="text-lg font-semibold mb-3">Menu</div>
              <div className="grid gap-2">
                <button className="w-full px-3 py-3 rounded-xl bg-zinc-800" onClick={() => { setMenuOpen(false); setSummaryOpen(true); }}>Innings Summary</button>
                <button className="w-full px-3 py-3 rounded-xl bg-yellow-400 text-black font-semibold" onClick={endInnings}>End Innings (Start Chase)</button>
                <button className="w-full px-3 py-3 rounded-xl bg-zinc-800" onClick={() => setMenuOpen(false)}>Close</button>
              </div>
            </div>
          </div>
        );

        const PlayerPicker = () => (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center" onClick={() => setPicker(null)}>
            <div className="bg-zinc-900 text-zinc-100 w-full sm:w-[420px] rounded-t-2xl sm:rounded-2xl p-4" onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-3">
                <div className="text-lg font-semibold">Pick {picker?.role === "bowler" ? "Bowler" : picker?.role === "striker" ? "Striker" : "Non-striker"}</div>
                <button className="px-3 py-1 rounded-xl bg-zinc-800" onClick={() => setPicker(null)}>Close</button>
              </div>
              <SavedPlayersList onSelect={(n) => applyPlayer(n)} disallow={null} />
            </div>
          </div>
        );

        const WicketModal = () => (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center" onClick={() => setWicketOpen(false)}>
            <div className="bg-zinc-900 text-zinc-100 w-full sm:w-[420px] rounded-t-2xl sm:rounded-2xl p-4" onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-3">
                <div className="text-lg font-semibold">Wicket — Who is out?</div>
                <button className="px-3 py-1 rounded-xl bg-zinc-800" onClick={() => setWicketOpen(false)}>Close</button>
              </div>
              <div className="grid grid-cols-1 gap-2">
                <button onClick={() => chooseOutAndPickReplacement("striker")} className="w-full px-3 py-3 rounded-xl bg-yellow-400 text-black font-semibold">Striker: {batsmen[innings].striker}</button>
                <button onClick={() => chooseOutAndPickReplacement("nonStriker")} className="w-full px-3 py-3 rounded-xl bg-zinc-800 font-medium">Non-striker: {batsmen[innings].nonStriker}</button>
              </div>
              <div className="mt-3 text-xs opacity-70">After choosing, you'll pick the new batsman from your list or add a new one.</div>
            </div>
          </div>
        );

        const SummaryModal = () => {
          const batMap = battingStats[innings] || {};
          const bowlMap = bowlingStats[innings] || {};
          const batRows = Object.keys(batMap);
          const bowlRows = Object.keys(bowlMap);
          const sr = (r, b) => (b ? ((r * 100) / b).toFixed(2) : "—");
          const econ = (runs, balls) => (balls ? (runs * 6) / balls : 0);
          const oversFmt = (balls) => `${Math.floor(balls / ballsPerOver)}.${balls % ballsPerOver}`;

          return (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center" onClick={() => setSummaryOpen(false)}>
              <div className="bg-zinc-900 text-zinc-100 w-full sm:w-[520px] rounded-t-2xl sm:rounded-2xl p-4" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between mb-3">
                  <div className="text-lg font-semibold">Innings Summary</div>
                  <button className="px-3 py-1 rounded-xl bg-zinc-800" onClick={() => setSummaryOpen(false)}>Close</button>
                </div>

                <div className="flex gap-2 mb-3">
                  {[1, 2].map((i) => (
                    <button key={i} onClick={() => setInnings(i)} className={`px-3 py-1 rounded-xl ${innings === i ? "bg-yellow-400 text-black" : "bg-zinc-800"}`}>Innings {i}</button>
                  ))}
                </div>

                <div className="mb-3 text-sm">Score: <span className="font-semibold">{score[innings].runs}-{score[innings].wkts}</span> · Overs: <span className="font-semibold">{oversDisplay}</span></div>

                <div className="text-sm font-semibold mb-1">Batters</div>
                <div className="rounded-xl overflow-hidden border border-zinc-800">
                  <table className="w-full text-sm">
                    <thead className="bg-zinc-800 text-zinc-200">
                      <tr>
                        <th className="text-left px-3 py-2">Name</th>
                        <th className="text-right px-2">R</th>
                        <th className="text-right px-2">B</th>
                        <th className="text-right px-2">4s</th>
                        <th className="text-right px-2">6s</th>
                        <th className="text-right px-3">SR</th>
                      </tr>
                    </thead>
                    <tbody>
                      {batRows.length === 0 && (
                        <tr><td className="px-3 py-2" colSpan={6}>No batting data yet.</td></tr>
                      )}
                      {batRows.map((name) => (
                        <tr key={name} className="odd:bg-zinc-950 even:bg-zinc-900">
                          <td className="px-3 py-2">{name}{batsmen[innings].striker === name ? "*" : ""}</td>
                          <td className="text-right px-2">{batMap[name].runs}</td>
                          <td className="text-right px-2">{batMap[name].balls}</td>
                          <td className="text-right px-2">{batMap[name].fours}</td>
                          <td className="text-right px-2">{batMap[name].sixes}</td>
                          <td className="text-right px-3">{sr(batMap[name].runs, batMap[name].balls)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className="text-sm font-semibold mt-4 mb-1">Bowlers</div>
                <div className="rounded-xl overflow-hidden border border-zinc-800">
                  <table className="w-full text-sm">
                    <thead className="bg-zinc-800 text-zinc-200">
                      <tr>
                        <th className="text-left px-3 py-2">Name</th>
                        <th className="text-right px-2">O</th>
                        <th className="text-right px-2">M</th>
                        <th className="text-right px-2">R</th>
                        <th className="text-right px-3">W</th>
                        <th className="text-right px-3">Econ</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.keys(bowlMap).length === 0 && (
                        <tr><td className="px-3 py-2" colSpan={6}>No bowling data yet.</td></tr>
                      )}
                      {Object.keys(bowlMap).map((name) => {
                        const bs = bowlMap[name];
                        return (
                          <tr key={name} className="odd:bg-zinc-950 even:bg-zinc-900">
                            <td className="px-3 py-2">{name}</td>
                            <td className="text-right px-2">{oversFmt(bs.balls)}</td>
                            <td className="text-right px-2">{bs.maidens || 0}</td>
                            <td className="text-right px-2">{bs.runs}</td>
                            <td className="text-right px-3">{bs.wickets}</td>
                            <td className="text-right px-3">{econ(bs.runs, bs.balls).toFixed(2)}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        };

        // Saved players list component (used in multiple modals)
        function SavedPlayersList({ onSelect, disallow }) {
          const [localName, setLocalName] = useState("");
          const [localCommon, setLocalCommon] = useState(false);
          const filtered = savedPlayers.filter((p) => p.name.toLowerCase().includes(setupSearch.toLowerCase()))
            .sort((a, b) => (a.common === b.common ? a.name.localeCompare(b.name) : a.common ? -1 : 1));

          return (
            <>
              <div className="mb-2 flex items-center gap-2">
                <input
                  placeholder="Search players"
                  value={setupSearch}
                  onChange={(e) => setSetupSearch(e.target.value)}
                  className="flex-1 px-3 py-2 rounded-lg bg-zinc-900 border border-zinc-700 outline-none"
                />
              </div>
              <div className="max-h-56 overflow-auto -mx-2 px-2">
                {filtered.map((p) => (
                  <div key={p.name} className="flex items-center justify-between py-2 border-b border-zinc-800">
                    <div className="flex items-center gap-2">
                      <span className={`font-medium ${disallow === p.name ? "opacity-40" : ""}`}>{p.name}</span>
                      {p.common && <span className="text-xs px-2 py-0.5 rounded-full bg-zinc-800">Common</span>}
                    </div>
                    <div className="flex items-center gap-2">
                      <button
                        disabled={disallow === p.name}
                        className={`px-2 py-1 rounded-lg ${disallow === p.name ? "bg-zinc-700" : "bg-yellow-400 text-black"}`}
                        onClick={() => onSelect(p.name)}
                      >Select</button>
                      <button className="px-2 py-1 rounded-lg bg-zinc-800" onClick={() => toggleCommonFor(p.name)}>{p.common ? "Unmark Common" : "Mark Common"}</button>
                    </div>
                  </div>
                ))}
                {filtered.length === 0 && (
                  <div className="text-sm opacity-70">No players match your search.</div>
                )}
              </div>
              <div className="mt-3 p-3 rounded-xl bg-zinc-800">
                <div className="text-sm mb-2 opacity-80">Add new player</div>
                <div className="flex items-center gap-2">
                  <input value={localName} onChange={(e) => setLocalName(e.target.value)} placeholder="Player name"
                    className="flex-1 px-3 py-2 rounded-lg bg-zinc-900 border border-zinc-700 outline-none" />
                  <button className="px-3 py-2 rounded-lg bg-yellow-400 text-black" onClick={() => {
                    const nm = localName.trim(); if (!nm) return;
                    setSavedPlayers((prev) => (prev.some((p) => p.name.toLowerCase() === nm.toLowerCase()) ? prev : [...prev, { name: nm, common: localCommon }]));
                    onSelect(nm);
                    setLocalName(""); setLocalCommon(false);
                  }}>Add</button>
                </div>
                <label className="flex items-center gap-2 mt-2 text-sm">
                  <input type="checkbox" checked={localCommon} onChange={(e) => setLocalCommon(e.target.checked)} />
                  Mark as Common player
                </label>
              </div>
            </>
          );
        }

        const ChaseSetupModal = () => (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center" onClick={() => setSetupOpen(false)}>
            <div className="bg-zinc-900 text-zinc-100 w-full sm:w-[420px] rounded-t-2xl sm:rounded-2xl p-4" onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-3">
                <div className="text-lg font-semibold">Start Innings 2</div>
                <button className="px-3 py-1 rounded-xl bg-zinc-800" onClick={() => setSetupOpen(false)}>Close</button>
              </div>
              <div className="text-sm mb-2 opacity-80">Target <span className="font-semibold">{target}</span>. Pick batting pair and bowler.</div>

              {setupStep === 1 && (
                <>
                  <div className="text-sm font-semibold mb-2">Pick <span className="text-yellow-300">Striker</span></div>
                  <SavedPlayersList onSelect={(n) => { setSetupStriker(n); setSetupStep(2); }} disallow={null} />
                </>
              )}

              {setupStep === 2 && (
                <>
                  <div className="text-sm font-semibold mb-2">Pick <span className="text-yellow-300">Non-striker</span></div>
                  <SavedPlayersList onSelect={(n) => { setSetupNonStriker(n); setSetupStep(3); }} disallow={setupStriker} />
                  <div className="mt-2 text-xs opacity-70">(Non-striker cannot be the same as striker)</div>
                </>
              )}

              {setupStep === 3 && (
                <>
                  <div className="text-sm font-semibold mb-2">Pick <span className="text-yellow-300">Bowler</span></div>
                  <SavedPlayersList onSelect={(n) => { setSetupBowler(n); }} disallow={null} />
                  <div className="mt-3 flex items-center justify-between">
                    <button className="px-3 py-2 rounded-xl bg-zinc-800" onClick={() => setSetupStep(2)}>Back</button>
                    <button
                      disabled={!setupStriker || !setupNonStriker || !setupBowler}
                      className={`px-4 py-2 rounded-xl font-semibold ${(!setupStriker || !setupNonStriker || !setupBowler) ? "bg-zinc-700" : "bg-yellow-400 text-black"}`}
                      onClick={() => {
                        // Apply selections
                        setBatsmen((p) => ({ ...p, 2: { striker: setupStriker, nonStriker: setupNonStriker } }));
                        setBowler((p) => ({ ...p, 2: setupBowler }));
                        // Prime stats
                        ensureBatter(setupStriker); ensureBatter(setupNonStriker); ensureBowler(setupBowler);
                        setSetupOpen(false);
                      }}
                    >Start Innings 2</button>
                  </div>
                </>
              )}

              {setupStep > 1 && setupStep < 3 && (
                <div className="mt-3">
                  <button className="px-3 py-2 rounded-xl bg-zinc-800" onClick={() => setSetupStep(setupStep - 1)}>Back</button>
                </div>
              )}
            </div>
          </div>
        );

        // ===== UI =====
        return (
          <div className="min-h-screen bg-zinc-950 text-zinc-100 flex justify-center">
            <div className="w-full max-w-md p-3 pb-20">
              {/* Header */}
              <div className="flex items-center justify-between py-2">
                <div className="text-sm opacity-80">{today} · Match #{matchNo}</div>
                <button aria-label="menu" className="text-2xl" onClick={() => setMenuOpen(true)}>☰</button>
              </div>

              {/* Innings tabs */}
              <div className="flex gap-2 mb-3">
                {[1, 2].map((i) => (
                  <button key={i} onClick={() => setInnings(i)} className={`flex-1 py-2 rounded-2xl font-medium ${innings === i ? "bg-yellow-400 text-black" : "bg-zinc-800"}`}>
                    Innings {i}
                  </button>
                ))}
              </div>

              {/* Scoreboard */}
              <div className="bg-zinc-900 rounded-2xl p-4 mb-3 shadow-lg">
                <div className="text-5xl font-extrabold tracking-wide">{score[innings].runs}/{score[innings].wkts}</div>
                <div className="flex items-center justify-between mt-1 text-sm">
                  <div>Overs {oversDisplay} ({activeBalls} balls)</div>
                  <button className="text-yellow-300" onClick={() => {
                    const current = activeOvers;
                    const val = window.prompt("Set total overs for this innings", String(current));
                    if (val === null || val === "") return; const n = Math.max(1, Number(val));
                    setTotalOvers((prev) => ({ ...prev, [innings]: n }));
                  }} title="Edit overs">✎</button>
                </div>

                {innings === 2 && (
                  <div className="mt-2 text-sm">
                    <div>Target <span className="font-semibold">{target}</span></div>
                    <div>
                      <span className="font-semibold">{reqRuns}</span> required in <span className="font-semibold">{Math.max(0, ballsRemaining)}</span> balls
                      {ballsRemaining > 0 && <span className="opacity-80"> · RRR {rrr.toFixed(2)}</span>}
                    </div>
                  </div>
                )}

                {/* Bowler */}
                <div className="mt-3">
                  <div className="text-xs opacity-70">CURRENT BOWLER</div>
                  <div className="flex items-center gap-2 text-2xl font-semibold">
                    <button className="underline decoration-dotted underline-offset-4" onClick={() => openPicker("bowler")}>{bowler[innings]}</button>
                  </div>
                </div>
              </div>

              {/* Batsmen row */}
              <div className="bg-zinc-900 rounded-2xl p-4 mb-3">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <button className="font-semibold underline decoration-dotted underline-offset-4" onClick={() => openPicker("striker")}>* {batsmen[innings].striker}</button>
                  </div>
                  <button onClick={() => setBatsmen((p) => ({ ...p, [innings]: { striker: p[innings].nonStriker, nonStriker: p[innings].striker } }))} className="px-3 py-1 rounded-xl bg-zinc-800">Swap</button>
                  <div className="flex items-center gap-2">
                    <button className="opacity-90 underline decoration-dotted underline-offset-4" onClick={() => openPicker("nonStriker")}>{batsmen[innings].nonStriker}</button>
                  </div>
                </div>

                {/* Over strips */}
                <div className="mt-3 text-sm">
                  <div className="opacity-70">LAST OVER</div>
                  <div className="font-mono">{lastOverStr[innings]}</div>
                  <div className="opacity-70 mt-2">CURRENT OVER</div>
                  <div className="font-mono">{(currentOverEvents[innings] || []).map((ev) => symbolFor(ev)).join(" ") || "—"}</div>
                </div>
              </div>

                {/* Action pad */}
              <div className="grid grid-cols-4 gap-2">
                <button onClick={() => addRuns(1)} className="px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">+1</button>
                <button onClick={() => addRuns(2)} className="px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">+2</button>
                <button onClick={() => addRuns(3)} className="px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">+3</button>
                <button onClick={() => addRuns(4)} className="px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">4</button>
                <button onClick={() => addRuns(6)} className="px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">6</button>
                <button onClick={dot} className="px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">•</button>
                <button onClick={wide} className="px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">Wide (Re)</button>
                <button onClick={noBall} className="px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">No Ball (Re,0)</button>
                <button onClick={wicket} className="col-span-2 px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">Wicket</button>
                <button onClick={manualOver} className="col-span-2 px-3 py-3 rounded-2xl font-semibold bg-yellow-400 text-black">Over</button>
                <button onClick={undo} className="col-span-4 px-3 py-3 rounded-2xl font-semibold bg-zinc-800">Undo</button>
              </div>

              <div className="mt-4 text-sm opacity-80">Auto striker swap on odd runs & end-of-over. Use ☰ → End Innings to start the chase.</div>
            </div>

            {menuOpen && <MenuModal />}
            {summaryOpen && <SummaryModal />}
            {picker && <PlayerPicker />}
            {wicketOpen && <WicketModal />}
            {setupOpen && <ChaseSetupModal />}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
